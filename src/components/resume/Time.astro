---
import type { HTMLAttributes } from "astro/types";
import {
  fixupHueLonger,
  formatHex,
  interpolate,
  modeOklch,
  parseHex,
  useMode,
  type Color,
} from "culori/fn";
import { env } from "@/utils/env";
import { unoTheme } from "@/utils";
import { CV_START, PRESENT } from "@/content";

type DateRange = [
  start: Date,
  /** A nullish end date means it is currently ongoing. */
  end?: Date | null | undefined,
];

type Props = HTMLAttributes<"time"> & {
  time: Date | DateRange;
  format?: Intl.DateTimeFormat;
  /** Don't use dates to determine text colors. */
  nocolormix?: boolean;
};

const defaultFormat = Intl.DateTimeFormat("en", {
  year: "numeric",
  month: "long",
  timeZone: "UTC",
});

const {
  time,
  format = defaultFormat,
  nocolormix = env.BUILD_INCLUDE_PERSONAL,
} = Astro.props;

const timelineColors: Color[] = [
  parseHex(unoTheme.colors.sky[700]),
  parseHex(unoTheme.colors.sky[500]),
];

// Register `oklch` color space used by the interpolator.
useMode(modeOklch);

/** @param t - Number between `[0, 1]` for interpolation. */
const mixTimelineColors: (t: number) => Color = interpolate(
  timelineColors,
  "oklch",
  // Longer path around hue circle is more colorful.
  // @ts-expect-error broken types
  { h: { fixup: fixupHueLonger } },
);

/** @returns Normalized value (between `[0, 1]`) for `date`. */
const unlerpDate = (date: Date): number =>
  (PRESENT.valueOf() - date.valueOf()) / (PRESENT.valueOf() - CV_START.valueOf());

function getTextColor(date: Date | null | undefined): string {
  if (nocolormix || !date)
    return unoTheme.colors.sky[700];
  const t = unlerpDate(date);
  const color = mixTimelineColors(t);
  return formatHex(color);
}

let text: string;
let textColor: string;

if (Array.isArray(time)) {
  const [start, end] = time;
  text = end
    ? format.formatRange(start, end)
    : `${format.format(start)} - Present`;
  // Use the `end` date to determine the color.
  textColor = getTextColor(end);
}
 else {
  text = format.format(time);
  textColor = getTextColor(time);
}
---

<time style={{ color: textColor }} class:list={[Astro.props.class]}>{text}</time>
